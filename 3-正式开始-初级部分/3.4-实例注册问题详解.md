# 实例注册问题详解

我们在**3.2.1章节**就讲过，我们在注册物品/方块时，物品/方块的实例都是`RegistryObject`。**这在不合适的时机调用就会引发空指针异常。**

但不合适的时机是什么时候？合适的时机又是什么时候？

## get()方法的调用时机

在实例完成注册之前，`get()`方法返回的是`null`。因此在实例完成注册之前调用，便是不合适的时机。而在实例完成注册之后，便是合适的时机。

但我并不知道实例何时完成注册，那怎么判断呢？总之，**一般在`FMLCommonSetupEvent`事件之前，统称为不合适的时机；在该事件之后，统称为合适的时机。**

## 由此会引发的问题

Minecraft的实例注册是有顺序的，比如：先注册方块，再注册物品。因此，由于`get()`方法的这种特性，会引发很多问题。

最典型的莫过于**向生物群系添加生物生成引发的空指针问题**。

生物群系和生物也一样需要注册。生物群系中提供了一个叫`addSpawn()`的方法，里面要求传入一个实体的实例。这个方法一般在生物群系的构造函数中调用，**也就是在注册生物群系时调用**。但无论你如何调用，只要传入的实体是使用`get()`方法获取的，**都会引发空指针异常**。

这是为什么呢？因为Minecraft是**先注册生物群系，再注册实体的**。在注册生物群系时就调用了`addSpawn()`方法，进而调用了开发者传入的实体实例的`get()`方法。**但此时实体还没被注册，因此`get()`方法获取到的是`null`**。

## 如何解决这个问题

分析我们刚刚遇到的问题。引发空指针异常，就是因为调用实体实例的`get()`方法获取到的是`null`。因此，**我们只要确保`get()`方法获取到的不是`null`即可**。

那如何解决？我们在注册物品的时候就讲过，注册物品有两种方法。第二种方法确实可以避免这种问题，**但有时会产生莫名其妙的错误**，因此我们还是从第一种方法入手。

首先，我们的实例是一个`RegistryObject`，只能使用`get()`方法。因此我们可以不用`RegistryObject`，而是直接用`Block`/`Item`。但`DeferredRegister`的`register()`方法返回的是一个`RegistryObject`，这显然不是我们想要的。

那怎么办呢？通过翻阅Minecraft的代码，我们发现，Minecraft原版的方块是这样注册的：

```java
public static final Block XXXXX = register(<block_name>, <block>);

private static Block register(String key, Block blockIn) {
	return Registry.register(Registry.BLOCK, key, blockIn);
}
```

很显然，Minecraft为了方便，创建了一个叫`register()`的方法，直接传入方块名与方块对象即可注册。

因此，我们也仿照Minecraft的写法，创建了一个方法：

**`src/main/java/com/github/vvvbbbcz/modderguide/block/MGBlocks.java（部分）`**：

```java
private static Block register(String name, Block block) {
	BLOCKS.register(name, () -> block);
	return block;
}
```

那么我们的方块实例就变成了这样：

**`src/main/java/com/github/vvvbbbcz/modderguide/block/MGBlocks.java（部分）`**：

```java
public static final Block TEST_BLOCK = register("test_block", new Block(Block.Properties.create(Material.WOOD).hardnessAndResistance(0.5F).sound(SoundType.STONE)));
public static final Block IRON_CHEST = register("iron_chest", new IronChest());
```

对于物品，也是一样的道理。